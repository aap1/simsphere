program test_prfile
  use simsphere_mod, only: cf, otemp, vgd, ugd, ntrp, vgs, ugs, ud, vd, td, &
                           qd, u_fine, v_fine, t_fine, q_fine, awind, eq
  use mod_testing, only: assert, initialize_tests, report_tests
  implicit none

  logical, dimension(:), allocatable :: tests
  logical :: test_failed
  integer :: i, n, ntests

  real, dimension(51), parameter :: u_fine_exp = (/                           &
        1.0,0.800000012,0.600000024,0.399999976,0.199999988,0.0,0.200000003,  &
        0.400000006,0.600000024,0.800000012,1.0,0.800000012,0.600000024,      &
        0.399999976,0.199999988,0.0,0.200000003,0.400000006,0.600000024,      &
        0.800000012,1.0,1.0,1.0,1.0,1.0,1.0,1.0,1.0,1.0,1.0,1.0,1.0,1.0,1.0,  &
        1.0,1.0,1.0,1.0,1.0,1.0,1.0,1.0,1.0,1.0,1.0,1.0,0.800000012,          &
        0.600000024,0.399999976,0.199999988,0.0/)
  real, dimension(51), parameter :: v_fine_exp = (/1.0,0.800000012,           &
        0.600000024,0.399999976,0.199999988,0.0,0.200000003,0.400000006,      &
        0.600000024,0.800000012,1.0,0.800000012,0.600000024,0.399999976,      &
        0.199999988,0.0,0.200000003,0.400000006,0.600000024,0.800000012,      &
        1.0,1.0,1.0,1.0,1.0,1.0,1.0,1.0,1.0,1.0,1.0,1.0,1.0,1.0,1.0,1.0,1.0,  &
        1.0,1.0,1.0,1.0,1.0,1.0,1.0,1.0,1.0,0.800000012,0.600000024,          &
        0.399999976,0.199999988,0.0/)
  real, dimension(51), parameter :: t_fine_exp = (/1.00000000,0.800000012,    &
        0.600000024,0.399999976,0.199999988,0.00000000,0.00000000,0.00000000, &
        0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,    &
        0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,    &
        0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,    &
        0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,    &
        0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,    &
        0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,    &
        0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,    &
        0.00000000/)
  real, dimension(51), parameter :: q_fine_exp = (/1.00000000,0.800000012,    &
        0.600000024,0.399999976,0.199999988,0.00000000,0.00000000,0.00000000, &
        0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,    &
        0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,    &
        0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,    &
        0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,    &
        0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,    &
        0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,    &
        0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,    &
        0.00000000/)

  ! Initialize mod_testing
  n = 1
  ntests = 5
  call initialize_tests(tests,ntests)

  CF = 9.19953891E-05
  OTEMP = 295.149994
  VGD(5) = 8.41951942
  VGD(3) = 8.43165302
  VGD(1) = 8.44378662
  UGD(5) = 13.0658665
  UGD(3) = 9.05783463
  UGD(1) = 5.04980326

  NTRP = 10
  VGS = 10.0
  UGS = 10.0
  ud = 1.0
  vd = 1.0
  VGD(NTRP) = 1.0
  UGD(NTRP) = 1.0

  ud = 0.0
  vd = 0.0
  ud(1) = 1.0
  vd(1) = 1.0
  ud(3) = 1.0
  vd(3) = 1.0
  do i = 5,NTRP
    ud(i) = 1.0
    vd(i) = 1.0
  end do
  td(1) = 1.0
  qd(1) = 1.0

  call prfile

  tests(n) = assert(eq(u_fine,u_fine_exp), 'u_fine')
  n = n + 1
  tests(n) = assert(eq(v_fine,v_fine_exp), 'v_fine') 
  n = n + 1
  tests(n) = assert(eq(t_fine,t_fine_exp), 't_fine')
  n = n + 1
  tests(n) = assert(eq(q_fine,q_fine_exp), 'q_fine')
  n = n + 1
  tests(n) = assert(eq(AWIND,1.41421354), 'AWIND')
  n = n + 1

  test_failed = .false.
  call report_tests(tests,test_failed)
  if (test_failed) stop 1


end program test_prfile
